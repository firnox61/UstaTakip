@model UstaTakipMvc.Web.Models.RepairJobs.RepairJobUpdateDto
@using UstaTakipMvc.Web.Models.RepairJobImages
@inject IConfiguration Config

@{
    Layout = "~/Views/Shared/_Layout.App.cshtml";
    ViewData["Title"] = "Tamir / Bakım Düzenle";

    var images = ViewBag.RepairJobImages as List<RepairJobImageListDto> ?? new();
}

<h4>Kayıt Düzenle</h4>
<hr />

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />

    <div class="row g-3">
        <div class="col-md-6">
            <label asp-for="VehicleId" class="form-label">Araç</label>
            <select asp-for="VehicleId" class="form-select" asp-items="ViewBag.VehicleOptions"></select>
        </div>

        <div class="col-md-6">
            <label asp-for="InsurancePolicyId" class="form-label">Sigorta Poliçesi</label>
            <select asp-for="InsurancePolicyId" class="form-select" asp-items="ViewBag.PolicyOptions">
                <option value="">— Seçiniz —</option>
            </select>
        </div>

        <div class="col-md-12">
            <label asp-for="Description" class="form-label">Açıklama</label>
            <input asp-for="Description" class="form-control" />
        </div>

        <div class="col-md-4">
            <label asp-for="Price" class="form-label">Ücret</label>
            <input asp-for="Price" type="number" step="0.01" class="form-control" />
        </div>

        <div class="col-md-4">
            <label asp-for="Date" class="form-label">Tarih</label>
            <input asp-for="Date" type="date" class="form-control" />
        </div>

        <div class="col-md-4">
            <label asp-for="InsurancePaymentRate" class="form-label">Sigorta Oranı (%)</label>
            <input asp-for="InsurancePaymentRate" type="number" min="0" max="100" class="form-control" />
        </div>

        <div class="col-md-6">
            <label asp-for="Status" class="form-label">Durum</label>
            <select asp-for="Status" class="form-select" asp-items="ViewBag.StatusOptions"></select>
        </div>
    </div>

    <div class="mt-4 d-flex gap-2">
        <button class="btn btn-primary">Güncelle</button>
        <a asp-action="Index" class="btn btn-outline-secondary">Geri</a>
    </div>
</form>

<hr />

<!-- ============================== -->
<!--       RESİM YÜKLEME FORMU     -->
<!-- ============================== -->
<h5>Yeni Resim Yükle</h5>

<form asp-controller="RepairJobImages"
      asp-action="Upload"
      method="post"
      enctype="multipart/form-data"
      class="row g-2">

    @Html.AntiForgeryToken()
    <input type="hidden" name="repairJobId" value="@Model.Id" />

    <div class="col-md-8">
        <input type="file" name="file" accept="image/*" class="form-control" required />
        <div class="form-text">PNG / JPG / WEBP / GIF — Max 5MB</div>
    </div>

    <div class="col-md-4 d-grid">
        <button type="submit" class="btn btn-outline-primary">
            <i class="fa-solid fa-upload me-1"></i> Yükle
        </button>
    </div>
</form>

<hr />
<h5 class="mt-4">Resimler</h5>

@{
    string apiBase = Config["ApiSettings:BaseUrl"]?.TrimEnd('/') ?? "";
    if (apiBase.EndsWith("/api", StringComparison.OrdinalIgnoreCase))
        apiBase = apiBase[..^4];
}

@if (images.Any())
{
    <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3 mt-2">
        @for (int i = 0; i < images.Count; i++)
        {
            var img = images[i];

            string path = img.ImagePath?.Trim() ?? "";
            if (!path.StartsWith("/"))
                path = "/" + path;

            string fullSrc = apiBase + path;

            <div class="col">
                <div class="card h-100 shadow-sm border-0">
                    <div class="ratio ratio-1x1">
                        <img src="@fullSrc"
                             class="img-fluid w-100 h-100 gallery-item"
                             style="object-fit:cover; cursor:pointer"
                             loading="lazy"
                             data-index="@i"
                             data-full="@fullSrc" />
                    </div>

                    <div class="card-body p-2">
                        <form asp-controller="RepairJobImages"
                              asp-action="Delete"
                              method="post"
                              class="d-grid">

                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@img.Id" />
                            <input type="hidden" name="repairJobId" value="@Model.Id" />

                            <button type="submit"
                                    class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Bu resmi silmek istiyor musun?')">
                                <i class="fa-solid fa-trash"></i> Sil
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-info mt-3">Bu kayda ait resim bulunmamaktadır.</div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- ============================== -->
    <!--     RESİM MODAL + ZOOM         -->
    <!-- ============================== -->
    <script>
        let images = Array.from(document.querySelectorAll('.gallery-item')).map(img => img.dataset.full);
        let currentIndex = 0;

        const modalImage = document.getElementById("modalImage");
        const imgModal = new bootstrap.Modal(document.getElementById("imageModal"));

        // --- Modal açma ---
        document.querySelectorAll('.gallery-item').forEach(img => {
            img.addEventListener("click", () => {
                currentIndex = parseInt(img.dataset.index);
                openImage(currentIndex);
            });
        });

        function openImage(index) {
            modalImage.src = images[index];
            resetZoom();
            imgModal.show();
        }

        document.getElementById("prevBtn").onclick = () => {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            openImage(currentIndex);
        };

        document.getElementById("nextBtn").onclick = () => {
            currentIndex = (currentIndex + 1) % images.length;
            openImage(currentIndex);
        };

        // ==========================
        //        ZOOM KODU
        // ==========================
        let scale = 1;
        let posX = 0, posY = 0;
        let isDragging = false;
        let startX, startY;

        function applyTransform() {
            modalImage.style.transform =
                `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        function resetZoom() {
            scale = 1;
            posX = 0;
            posY = 0;
            applyTransform();
        }

        // Mouse wheel zoom
        modalImage.addEventListener("wheel", (e) => {
            e.preventDefault();

            if (e.deltaY < 0 && scale < 5) scale += 0.1;
            if (e.deltaY > 0 && scale > 1) scale -= 0.1;

            applyTransform();
        });

        // Drag hareketi
        modalImage.addEventListener("mousedown", (e) => {
            isDragging = true;
            startX = e.clientX - posX;
            startY = e.clientY - posY;
        });

        modalImage.addEventListener("mousemove", (e) => {
            if (!isDragging) return;

            posX = e.clientX - startX;
            posY = e.clientY - startY;
            applyTransform();
        });

        modalImage.addEventListener("mouseup", () => isDragging = false);
        modalImage.addEventListener("mouseleave", () => isDragging = false);
    </script>
}
