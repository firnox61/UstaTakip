@model Guid
@using UstaTakipMvc.Web.Models.RepairJobImages
@inject IConfiguration Config

@{
    var repairJobId = Model;

    string apiBase = Config["ApiSettings:BaseUrl"]?.TrimEnd('/') ?? "";
    if (apiBase.EndsWith("/api", StringComparison.OrdinalIgnoreCase))
        apiBase = apiBase[..^4];

    var imgs = ViewBag.RepairJobImages as List<RepairJobImageListDto> ?? new();
}

<hr />
<h5 class="mt-4">Tamir / Bakım Resimleri</h5>

<form asp-controller="RepairJobImages"
      asp-action="Upload"
      method="post"
      enctype="multipart/form-data"
      class="row g-2">

    @Html.AntiForgeryToken()
    <input type="hidden" name="repairJobId" value="@repairJobId" />

    <div class="col-md-8">
        <input type="file" name="file" accept="image/*" class="form-control" required />
        <div class="form-text">PNG / JPG / WEBP / GIF — Max 5MB</div>
    </div>

    <div class="col-md-4 d-grid">
        <button type="submit" class="btn btn-outline-primary">
            <i class="fa-solid fa-upload me-1"></i> Yükle
        </button>
    </div>
</form>

@if (imgs.Any())
{
    <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3 mt-2">
        @for (int i = 0; i < imgs.Count; i++)
        {
            var img = imgs[i];
            string fullSrc = apiBase + (img.ImagePath.StartsWith("/") ? img.ImagePath : "/" + img.ImagePath);

            <div class="col">
                <div class="card h-100 shadow-sm border-0">
                    <div class="ratio ratio-1x1">
                        <img src="@fullSrc"
                             class="img-fluid w-100 h-100 gallery-item"
                             style="object-fit:cover; cursor:pointer"
                             loading="lazy"
                             data-index="@i"
                             data-full="@fullSrc"
                             onerror="this.src='/images/no-image.png'" />
                    </div>

                    <div class="card-body p-2 text-center">
                        <form asp-controller="RepairJobImages"
                              asp-action="Delete"
                              method="post">

                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@img.Id" />
                            <input type="hidden" name="repairJobId" value="@repairJobId" />

                            <button type="submit"
                                    class="btn btn-sm btn-outline-danger w-100"
                                    onclick="return confirm('Bu resmi silmek istiyor musun?')">
                                <i class="fa-solid fa-trash"></i> Sil
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-info mt-3">Bu tamir kaydına ait resim bulunmuyor.</div>
}
