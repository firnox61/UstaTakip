@using System.Text.Json
@using UstaTakipMvc.Web.Models.Vehicles
@model VehicleCreateDto

@{
    Layout = "~/Views/Shared/_Layout.App.cshtml";
    ViewData["Title"] = "Araç Ekle";
}

<h4>Araç Ekle</h4>
<hr />

<form asp-action="Create" method="post" novalidate>
    @Html.AntiForgeryToken()

    @await Html.PartialAsync("_VehicleForm", Model)

    <button class="btn btn-primary mt-3">
        Kaydet
    </button>
    <a asp-action="Index" class="btn btn-outline-secondary mt-3">İptal</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // C# Dictionary<string, List<string>> → JS objesine çevir
        const models = @Html.Raw(JsonSerializer.Serialize(ViewBag.Models));

        const brandSelect = document.getElementById("brandSelect");
        const modelSelect = document.getElementById("modelSelect");
        const brandManual = document.getElementById("brandManual");
        const modelManual = document.getElementById("modelManual");

        function fillModels(brand) {
            modelSelect.innerHTML = "<option value=''>Model seçin</option>";

            if (brand && models[brand]) {
                models[brand].forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m;
                    opt.textContent = m;
                    modelSelect.appendChild(opt);
                });
            }
        }

        // Marka değişince modelleri doldur
        brandSelect.addEventListener("change", function () {
            const brand = this.value;
            fillModels(brand);

            // Kullanıcı dropdown'dan seçtiyse manuel alanı temizle
            if (brand) {
                brandManual.value = brand;
            }
        });

        // Model seçilince manuel model alanını doldur
        modelSelect.addEventListener("change", function () {
            const model = this.value;
            if (model) {
                modelManual.value = model;
            }
        });

        // Sayfa ilk yüklendiğinde (validation hatası sonrası geri gelme vb.)
        const selectedBrand = '@(Model.Brand ?? "")';
        const selectedModel = '@(Model.Model ?? "")';

        if (selectedBrand && models[selectedBrand]) {
            brandSelect.value = selectedBrand;
            fillModels(selectedBrand);

            if (selectedModel) {
                modelSelect.value = selectedModel;
            }
        }
    </script>
}
